<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Mini App Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root {
  --bg-color: #121212;
  --primary-color: #4f9dff;
  --accent-color: #28a745;
  --text-color: #f0f0f0;
}
body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg,#0f0f0f,#1a1a1a); color: var(--text-color); padding:10px; min-height:100vh; }
.avatar-container{text-align:center;margin-bottom:20px;}
.avatar-container img{width:100px;height:100px;border-radius:50%;border:3px solid rgba(255,255,255,0.3);box-shadow:0 4px 12px rgba(0,0,0,0.5);}
h1{text-align:center;padding:10px 0 20px;font-size:26px;color: var(--primary-color);}
.category{background: rgba(255,255,255,0.05);backdrop-filter: blur(10px);border-radius: 16px;border:1px solid rgba(255,255,255,0.1);padding:15px;margin-bottom:15px;box-shadow:0 8px 32px rgba(0,0,0,0.37);transition:transform 0.2s,box-shadow 0.2s;}
.category:hover{transform:translateY(-3px);box-shadow:0 12px 40px rgba(0,0,0,0.5);}
.category h2{font-size:20px;margin-bottom:10px;color: var(--primary-color);}
.link-btn{display:block;width:100%;padding:12px;margin:6px 0;text-align:center;color:#fff;text-decoration:none;border-radius:12px;font-size:16px;background: rgba(255,255,255,0.1);backdrop-filter: blur(8px);border:1px solid rgba(255,255,255,0.2);box-shadow:0 4px 16px rgba(0,0,0,0.3);transition:transform 0.2s,background 0.2s;}
.link-btn:hover{transform:translateY(-2px);background: rgba(255,255,255,0.15);}
#adminBtn{display:none;width:90%;margin:10px auto;padding:12px;text-align:center;font-size:16px;border-radius:12px;color:#fff;cursor:pointer;background: rgba(40, 167, 69,0.2);backdrop-filter: blur(10px);border:1px solid rgba(40,167,69,0.4);box-shadow:0 4px 16px rgba(0,0,0,0.3);}
#adminBtn:hover{transform:translateY(-2px);background: rgba(40,167,69,0.3);}
#adminPanel{display:none;padding:10px;}
#adminPanel h2{color: var(--accent-color); margin-top:10px;}
.user-table{width:100%;border-collapse:collapse;margin-bottom:10px;}
.user-table th,.user-table td{border:1px solid rgba(255,255,255,0.2);padding:5px;text-align:center;}
#pushForm input,#pushForm textarea{width:100%;margin:5px 0;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.05);color:#fff;}
#pushForm button{width:100%;padding:10px;margin-top:5px;border:none;border-radius:12px;background:var(--accent-color);color:#fff;cursor:pointer;transition:0.2s;}
#pushForm button:hover{background:#1e7e34;}
@media(max-width:480px){h1{font-size:22px;}.category h2{font-size:18px;}.link-btn{font-size:15px;padding:10px;}#pushForm button{font-size:15px;padding:8px;}}
</style>
</head>
<body>
<div class="avatar-container">
  <img src="https://i.pravatar.cc/150?img=12" alt="–ê–≤–∞—Ç–∞—Ä">
</div>
<h1>–ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–µ —Å—Å—ã–ª–∫–∏</h1>
<div id="categories"></div>
<button id="adminBtn">–ê–¥–º–∏–Ω–∫–∞</button>
<div id="adminPanel">
  <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
  <div id="stats"></div>
  <h2>–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
  <table class="user-table" id="userTable">
    <tr><th>Username</th><th>Telegram ID</th><th>–ü–æ–¥–ø–∏—Å–∞–Ω</th></tr>
  </table>
  <h2>–†–∞—Å—Å—ã–ª–∫–∞ –ø—É—à–µ–π</h2>
  <form id="pushForm">
    <input type="text" id="pushTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫">
    <textarea id="pushMessage" rows="3" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ"></textarea>
    <input type="text" id="pushLink" placeholder="–°—Å—ã–ª–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏">
    <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–º</button>
  </form>
</div>
<script>
// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API
const CONFIG = {
  API_URL: 'https://telegram-miniapp-api.worknotdead.workers.dev',  // –ü–†–û–î–ê–ö–®–ï–ù
};

const tg = Telegram.WebApp;

// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
let user = tg.initDataUnsafe.user || {
  id: 0,
  username: 'guest',
  first_name: 'Guest',
  language_code: 'ru'
};

console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', user);

// –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ Telegram WebApp
if (tg.expand) tg.expand();
if (tg.ready) tg.ready();

// –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö fetch –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
async function safeFetch(url, options = {}) {
  try {
    const response = await fetch(url, {
      ...options,
      headers: {
        'Content-Type': 'application/json',
        ...options.headers,
      },
    });

    if (!response.ok) {
      const error = await response.json().catch(() => ({ error: 'Unknown error' }));
      throw new Error(error.error || `HTTP ${response.status}`);
    }

    return await response.json();
  } catch (error) {
    console.error('Fetch error:', error);
    showError(error.message || '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.');
    throw error;
  }
}

// –ü–æ–∫–∞–∑ –æ—à–∏–±–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
function showError(message) {
  console.error('‚ùå –û—à–∏–±–∫–∞:', message);
  if (tg.showAlert) {
    tg.showAlert(message);
  } else {
    alert(message);
  }
}

// –ü–æ–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
function showSuccess(message) {
  console.log('‚úÖ –£—Å–ø–µ—Ö:', message);
  if (tg.showAlert) {
    tg.showAlert(message);
  } else {
    alert(message);
  }
}

// –ü–æ–∫–∞–∑ –∑–∞–≥—Ä—É–∑–∫–∏
function showLoading(elementId) {
  const element = document.getElementById(elementId);
  if (element) {
    element.innerHTML = '<p style="text-align:center;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</p>';
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
async function initApp() {
  try {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
    console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', user);
    
    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await safeFetch(`${CONFIG.API_URL}/api/user`, {
      method: 'POST',
      body: JSON.stringify(user),
    }).catch(err => console.warn('User registration failed:', err));

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    console.log('üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞...');
    await checkAdmin();

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤
    console.log('üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏—Ö —Å—Å—ã–ª–æ–∫...');
    await loadPartners();
    
    console.log('‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');

  } catch (error) {
    console.error('‚ùå Init error:', error);
    showError('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
  }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
async function checkAdmin() {
  try {
    const data = await safeFetch(`${CONFIG.API_URL}/api/me`, {
      method: 'POST',
      body: JSON.stringify(user),
    });

    if (data.is_admin) {
      const btn = document.getElementById('adminBtn');
      btn.style.display = 'block';
      btn.onclick = toggleAdminPanel;
    }
  } catch (error) {
    console.error('Admin check failed:', error);
  }
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
function toggleAdminPanel() {
  const panel = document.getElementById('adminPanel');
  
  // –ü–æ–ª—É—á–∞–µ–º computed style, —Ç–∞–∫ –∫–∞–∫ inline style –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º
  const currentDisplay = window.getComputedStyle(panel).display;
  const isVisible = currentDisplay !== 'none';
  
  console.log('üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏. –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:', isVisible ? '–≤–∏–¥–Ω–∞' : '—Å–∫—Ä—ã—Ç–∞');
  
  if (isVisible) {
    panel.style.display = 'none';
    console.log('‚ùå –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Å–∫—Ä—ã—Ç–∞');
  } else {
    panel.style.display = 'block';
    console.log('‚úÖ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –ø–æ–∫–∞–∑–∞–Ω–∞');
    loadAdminData();
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤
async function loadPartners() {
  const container = document.getElementById('categories');
  showLoading('categories');

  try {
    const partners = await safeFetch(`${CONFIG.API_URL}/api/partners`);

    if (!partners || partners.length === 0) {
      container.innerHTML = '<p style="text-align:center;">–ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–µ —Å—Å—ã–ª–∫–∏ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>';
      return;
    }

    // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    const categories = {};
    partners.forEach(p => {
      if (!categories[p.category]) categories[p.category] = [];
      categories[p.category].push(p);
    });

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    container.innerHTML = '';
    for (const [catName, links] of Object.entries(categories)) {
      const div = document.createElement('div');
      div.className = 'category';

      const h = document.createElement('h2');
      h.textContent = catName;
      div.appendChild(h);

      links.forEach(link => {
        const a = document.createElement('a');
        a.className = 'link-btn';
        a.href = link.url;
        a.target = '_blank';
        a.textContent = link.title;
        a.onclick = (e) => handleLinkClick(e, link);
        div.appendChild(a);
      });

      container.appendChild(div);
    }
  } catch (error) {
    container.innerHTML = '<p style="text-align:center;color:red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤</p>';
  }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ —Å—Å—ã–ª–∫–µ
async function handleLinkClick(event, link) {
  try {
    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–ª–∏–∫–∞ (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –ø–µ—Ä–µ—Ö–æ–¥)
    safeFetch(`${CONFIG.API_URL}/api/click`, {
      method: 'POST',
      body: JSON.stringify({
        telegram_id: user.id,
        url: link.url,
      }),
    }).catch(err => console.warn('Click tracking failed:', err));

    // –í–∏–±—Ä–∞—Ü–∏—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
    if (tg.HapticFeedback) {
      tg.HapticFeedback.impactOccurred('light');
    }
  } catch (error) {
    console.error('Link click handler error:', error);
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
async function loadAdminData() {
  const statsDiv = document.getElementById('stats');
  const table = document.getElementById('userTable');

  showLoading('stats');
  table.innerHTML = '<tr><th>Username</th><th>Telegram ID</th><th>–ü–æ–¥–ø–∏—Å–∞–Ω</th></tr>';

  try {
    const users = await safeFetch(`${CONFIG.API_URL}/api/subscribers`);

    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    const subscribed = users.filter(u => u.subscribed).length;
    const unsubscribed = users.length - subscribed;
    statsDiv.innerHTML = `
      <p>
        <strong>–í—Å–µ–≥–æ:</strong> ${users.length}<br>
        <strong>–ü–æ–¥–ø–∏—Å–∞–Ω—ã:</strong> ${subscribed}<br>
        <strong>–û—Ç–ø–∏—Å–∞–Ω—ã:</strong> ${unsubscribed}
      </p>
    `;

    // –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    users.forEach(u => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${u.username || 'N/A'}</td>
        <td>${u.telegram_id}</td>
        <td>${u.subscribed ? '‚úÖ' : '‚ùå'}</td>
      `;
      table.appendChild(tr);
    });
  } catch (error) {
    statsDiv.innerHTML = '<p style="color:red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
  }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Ä–∞—Å—Å—ã–ª–∫–∏
document.getElementById('pushForm').onsubmit = async (e) => {
  e.preventDefault();

  const title = document.getElementById('pushTitle').value.trim();
  const msg = document.getElementById('pushMessage').value.trim();
  const link = document.getElementById('pushLink').value.trim();

  // –í–∞–ª–∏–¥–∞—Ü–∏—è
  if (!title || !msg || !link) {
    showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
    return;
  }

  if (!link.startsWith('http://') && !link.startsWith('https://')) {
    showError('–°—Å—ã–ª–∫–∞ –¥–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http:// –∏–ª–∏ https://');
    return;
  }

  const submitBtn = e.target.querySelector('button');
  const originalText = submitBtn.textContent;
  submitBtn.disabled = true;
  submitBtn.textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';

  try {
    const result = await safeFetch(`${CONFIG.API_URL}/api/push`, {
      method: 'POST',
      body: JSON.stringify({ title, msg, link }),
    });

    showSuccess(`‚úÖ –ü—É—à –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! (${result.sent || 0}/${result.total || 0} —É—Å–ø–µ—à–Ω–æ)`);

    // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
    document.getElementById('pushTitle').value = '';
    document.getElementById('pushMessage').value = '';
    document.getElementById('pushLink').value = '';

  } catch (error) {
    // –û—à–∏–±–∫–∞ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω–∞ –≤ safeFetch
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = originalText;
  }
};

// –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.addEventListener('DOMContentLoaded', initApp);

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
window.addEventListener('error', (event) => {
  console.error('Global error:', event.error);
});

window.addEventListener('unhandledrejection', (event) => {
  console.error('Unhandled promise rejection:', event.reason);
});
</script>
</body>
</html>
