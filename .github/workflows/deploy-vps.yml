name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Add VPS to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H 46.17.44.239 >> ~/.ssh/known_hosts

    - name: Create .env file
      run: |
        cat > .env << 'EOF'
        BOT_TOKEN=${{ secrets.BOT_TOKEN }}
        WEBAPP_URL=${{ secrets.WEBAPP_URL }}
        WEBHOOK_URL=https://app.okolotattooing.ru
        BASE_URL=https://app.okolotattooing.ru
        SHEET_ID=${{ secrets.SHEET_ID }}
        CREDENTIALS_JSON=${{ secrets.CREDENTIALS_JSON }}
        REDIS_HOST=redis
        REDIS_PORT=6379
        NODE_ENV=production
        PORT=3000
        SERVER_URL=https://app.okolotattooing.ru
        EOF

    - name: Install Docker on VPS
      run: |
        ssh root@46.17.44.239 << 'ENDSSH'
          # Check if Docker is installed
          if ! command -v docker &> /dev/null; then
            echo "Docker not found. Installing Docker..."

            # Update package list
            apt-get update

            # Install prerequisites
            apt-get install -y ca-certificates curl gnupg lsb-release

            # Add Docker's official GPG key
            install -m 0755 -d /etc/apt/keyrings
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
            chmod a+r /etc/apt/keyrings/docker.gpg

            # Set up the repository
            echo \
              "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
              $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

            # Install Docker Engine
            apt-get update
            apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

            # Start Docker service
            systemctl start docker
            systemctl enable docker

            echo "âœ… Docker installed successfully"
          else
            echo "âœ… Docker is already installed"
            docker --version
          fi
        ENDSSH

    - name: Deploy to VPS
      run: |
        # Create directory if it doesn't exist
        ssh root@46.17.44.239 "mkdir -p /opt/telegram-miniapp"

        # Copy files to VPS
        rsync -avz --delete \
          --exclude '.git' \
          --exclude '.github' \
          --exclude 'node_modules' \
          --exclude 'worker' \
          --exclude '.wrangler' \
          --exclude 'logs' \
          ./ root@46.17.44.239:/opt/telegram-miniapp/

        # Deploy on VPS
        ssh root@46.17.44.239 << 'ENDSSH'
          cd /opt/telegram-miniapp

          echo "=== Stopping containers ==="
          docker compose down || true

          echo ""
          echo "=== Cleaning Docker build cache ==="
          docker builder prune -af
          docker system prune -f

          echo ""
          echo "=== Building images ==="
          docker compose build --no-cache --pull --progress=plain

          if [ $? -ne 0 ]; then
            echo "âŒ Build failed!"
            exit 1
          fi

          echo ""
          echo "=== Starting containers ==="
          docker compose up -d

          if [ $? -ne 0 ]; then
            echo "âŒ Failed to start containers!"
            docker compose ps -a
            docker compose logs
            exit 1
          fi

          echo ""
          echo "=== Container status ==="
          docker compose ps

          echo ""
          echo "=== Initial logs ==="
          docker compose logs --tail=50

          echo ""
          echo "âœ… Deployment completed"
        ENDSSH

    - name: Wait for services to start
      run: |
        echo "Waiting 15 seconds for services to start..."
        sleep 15

    - name: Set Telegram Webhook
      run: |
        # Set webhook to fixed path /bot (no token in URL for security)
        response=$(curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/setWebhook?url=https://app.okolotattooing.ru/bot")
        echo "Webhook response: $response"

        # Check if webhook was set successfully
        if echo "$response" | grep -q '"ok":true'; then
          echo "âœ… Webhook set successfully"

          # Verify webhook info
          info=$(curl -s "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/getWebhookInfo")
          echo "Webhook info: $info"
        else
          echo "âŒ Failed to set webhook"
          exit 1
        fi

    - name: Health Check
      run: |
        echo "Running health check..."

        # Retry up to 5 times with 5 second delay
        for i in {1..5}; do
          if curl -f -s https://app.okolotattooing.ru/api/health; then
            echo "âœ… Health check passed"
            exit 0
          fi
          echo "Attempt $i failed, retrying in 5 seconds..."
          sleep 5
        done

        echo "âŒ Health check failed after 5 attempts"
        echo ""
        echo "=== Showing container logs for debugging ==="
        ssh root@46.17.44.239 "cd /opt/telegram-miniapp && docker compose ps"
        echo ""
        ssh root@46.17.44.239 "cd /opt/telegram-miniapp && docker compose logs --tail=100 app"
        exit 1

    - name: Verify Deployment
      if: always()
      run: |
        echo "=== Deployment Verification ==="

        # Check container status
        ssh root@46.17.44.239 "cd /opt/telegram-miniapp && docker compose ps"

        echo ""
        echo "=== Recent Logs ==="
        ssh root@46.17.44.239 "cd /opt/telegram-miniapp && docker compose logs --tail=20 app"

    - name: Notify on Failure
      if: failure()
      run: |
        echo "ðŸš¨ Deployment failed! Check the logs above for details."
        ssh root@46.17.44.239 "cd /opt/telegram-miniapp && docker compose logs --tail=100" || true